# Home Pal
  This repo's purpose is to create a home dashboard with multiple features and information useful for home managment, useful for display on a tablet

  It is an attempt to see what AI code generator can do with local models and testing it's capabilities

# Functions to add:
- Recycling days
- add ability to set task due, and only display tasks that are due
- implement the train alerts
- recuring shopping list
- add tests

# Persona character:
The persona character image is generated by Stable Diffusion (`Lykon/dreamshaper-8`) and cached in `tmp/persona/`. Images are generated once per weather+time+mood state and reused on subsequent loads.

- **Force regeneration**: delete `tmp/persona/` and refresh the dashboard — new images will be generated for the current state
- **Character consistency**: controlled by a fixed seed (42) and `CHARACTER_PREFIX` in `agents/persona_states.py`. Changing either requires deleting the entire cache
- **Quotes**: generated by Ollama and refreshed every 10 minutes. If Ollama is unavailable, hardcoded fallback quotes are used silently
- **State key format**: `{weather}_{time_period}_{mood}` (e.g. `cold_evening_tired`), `welcome_{period}`, or fixed keys (`in_meeting_focused`, `meeting_soon_flustered`, holiday keys, context override keys)
- **Time periods**: `morning` (5–9h), `day` (10–17h), `evening` (18–21h), `night` (22–23h), `late_night` (0–4h)
- **Per-period scene overrides**: states can have `prompt_overrides: {period: prompt}` in `persona_states.py` — used so outdoor states (mild/warm/hot) show indoor scenes at late night

## SD pipeline configuration
The image generation pipeline is tuned for the dreamshaper-8 anime model:

| Setting | Value | Notes |
|---|---|---|
| Scheduler | DPM++ 2M Karras | `DPMSolverMultistepScheduler`, `use_karras_sigmas=True`, `algorithm_type="dpmsolver++"` |
| Inference steps | 20 | 25 overprocesses with this scheduler, causing distortion |
| Guidance scale | 6.5 | Higher values cause artefacts |
| CLIP skip | 2 | Required for anime models |
| VAE | `stabilityai/sd-vae-ft-mse` | Better colour and detail than default |
| Embeddings | compel | Bypasses 77-token CLIP limit; prompts use `prompt_embeds` not strings |

# Setting up Ollama (persona quotes):
The persona character generates dynamic quotes using a local LLM via Ollama. The server starts and manages Ollama automatically — you only need to install it once.

1. Download and install Ollama from https://ollama.com/download
2. The installer adds `ollama` to your system PATH automatically
3. Start the Home Pal server — it will pull the `llama3.2` model on first run (≈2 GB download) and start Ollama as a subprocess
4. On subsequent starts the model is already present and loads instantly

If you prefer a smaller/faster model, change `OLLAMA_MODEL` in `services/ollama_service.py` (e.g. `llama3.2:1b` is ≈800 MB).

# Setting up MQTT (presence & air quality):
The persona reacts to presence (BLE iBeacon via ESP32) and indoor air quality (VOC via Zigbee2MQTT). Both are read from an MQTT broker.

1. Set the broker hostname and topic config in `config.py` (`MQTT_BROKER`, `PRESENCE_TOPIC`, `AIC_TOPIC`, `VOC_FIELD`, `VOC_THRESHOLD`)
2. Create the credentials file `env/secrets/mqtt.json`:
```json
{
  "username": "your-mqtt-username",
  "password": "your-mqtt-password"
}
```
3. Restart the server — it will subscribe automatically and print `[HomeContext] MQTT connected` on success

If `env/secrets/mqtt.json` is absent, the server connects without credentials (useful for unauthenticated brokers).
If the broker is unreachable, the persona defaults to always-home behaviour and logs a retry message every 30 seconds.

# Setting up Telegram (notifications & commands):
The Persona character can send you notifications and respond to commands over Telegram. All messages are sent as text in her character style.

**Outbound notifications:**
- Arrival home — she greets you with a context-aware message
- Departure with lights on — she asks if you want her to turn them off (inline Yes~/Never mind buttons)
- Poor air quality — she alerts you when indoor VOC levels spike

**Inbound commands (send these to the bot):**
- `turn on/off the lights` — toggles or explicitly sets the LED strip
- `add [item] to shopping list` — adds an item to the dashboard shopping list
- `add [item] to todo` — adds a task to the dashboard to-do list
- `what's the weather` / `weather tomorrow` — weather summary
- `what's today` / `tomorrow` — calendar events

**Setup:**
1. Open Telegram and message @BotFather — send `/newbot` and follow the prompts to get a **bot token**
2. Start a chat with your new bot, then message @userinfobot to get your **chat ID**
3. Create `env/secrets/telegram.json`:
```json
{
  "bot_token": "YOUR_BOT_TOKEN",
  "chat_id": "YOUR_CHAT_ID"
}
```
4. Install the dependency: `pip install pyTelegramBotAPI`
5. Restart the server — it will print `[Telegram] Bot started` on success

If `env/secrets/telegram.json` is absent the bot is silently disabled and everything else continues to work normally.

# Setting up google calender:
"Please follow these steps to set up Google Calendar API credentials:
1. Go to https://console.developers.google.com/
2. Create a new project or select an existing one.
3. Navigate to 'APIs & Services' > 'Credentials'.
4. Click on 'Create Credentials' and select 'OAuth client ID'.
5. Configure the consent screen if prompted.
6. Set the application type to 'Web application', add authorized redirect URIs (e.g., http://127.0.0.1:5000/oauth/oauth2callback), and create the credentials.
7. Download the JSON file containing your client ID and secret.
8. Place this JSON file in your project directory and put it in `env/secrets/client_secret.json`
9. Add the users to the test users list.
10. Enable Google Calendar API
